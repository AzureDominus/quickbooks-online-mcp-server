# MCP tool output normalization (mcporter / generated CLI)

Date: 2026-02-01

## Context

We use this MCP server via:

- `mcporter call QuickBooks.<tool> --output json`
- a bundled CLI generated by mcporter (`mcporter generate-cli --server QuickBooks ...`)

Both of these workflows work best when a tool returns **a single JSON payload**.

## Problem: “weird JSON” tool responses

Many tools were returning **multiple `content` entries** and/or mixing human-oriented text with JSON.

Common patterns:

1. **Human prefix + JSON block**

```ts
return {
  content: [
    { type: 'text', text: `Found ${n} purchases:` },
    { type: 'text', text: JSON.stringify(payload, null, 2) },
  ],
};
```

2. **One JSON object per line / per content chunk** (especially `search_*` tools)

```ts
return {
  content: [
    { type: 'text', text: `Found ${results.length} vendors:` },
    ...results.map((v) => ({ type: 'text', text: JSON.stringify(v) })),
  ],
};
```

Why this is a problem:

- `mcporter --output json` expects the tool output to be parseable as JSON.
- The generated CLI also relies on JSON-only output for predictable parsing.
- The multi-chunk format creates edge cases (e.g., quoting/backticks/escapes) and forces callers to implement bespoke parsing.

## Goal

Make tool outputs **machine-readable by default**:

- A tool success response should emit **exactly one** `content` text item.
- That text item should be a JSON string (from `JSON.stringify(...)`) with no extra prefix text.
- Count-only responses should return `{"count": <number>}`.

## Fix implemented

### 1) Normalize success outputs to a single JSON payload

Updated tools in `src/tools/*.tool.ts` to return:

```ts
return {
  content: [{ type: 'text' as const, text: JSON.stringify(payload) }],
};
```

### 2) Normalize count-only outputs

For tools that support count-only mode, return:

```ts
return {
  content: [{ type: 'text' as const, text: JSON.stringify({ count }) }],
};
```

### 3) Keep errors as plain strings (for now)

Most tools still return human-readable error strings like:

```ts
{
  content: [{ type: 'text', text: `Error searching vendors: ${response.error}` }];
}
```

This is deliberate for now (easy to read). If we want fully machine-readable errors later, we can standardize to:

```json
{ "error": { "message": "..." } }
```

### Tools updated

The normalization pass covered (at minimum):

- `search_*`: vendors, purchases, customers, bills, bill payments, employees, items, estimates, invoices, accounts, tax codes
- `get_*` / `read_*`: customer, vendor, purchase, employee, estimate, journal entry, bill payment, tax code, invoice, item
- `get_attachments`
- `health_check`
- create/update/delete tools that previously returned multiple `content` items

## Verification

Examples that should now produce clean JSON:

```bash
mcporter call QuickBooks.search_vendors limit:3 --output json
mcporter call QuickBooks.search_tax_codes --output json
mcporter call QuickBooks.search_purchases desc:TxnDate limit:3 --output json
mcporter call QuickBooks.search_customers limit:3 --output json
mcporter call QuickBooks.health_check --output json
```

The bundled CLI should also work cleanly:

```bash
cd /home/timmy/claw-spaces/don
mcporter generate-cli --server QuickBooks --output ./generated/QuickBooks.ts --bundle ./bin/quickbooks
./bin/quickbooks -o json search-vendors --limit 3
```

## Fixed: `count:true` now works for all search endpoints

Previously, `count:true` caused QBO query parse errors for some endpoints (e.g., `search_invoices`, `search_items`). This has been fixed.

### Root cause

The issue was in how `buildQuickbooksSearchCriteria` passed the count option to `node-quickbooks`. The library looks for a top-level `count: true` property on objects in the criteria array, but we were adding `{field: 'count', value: true}` instead. This caused `node-quickbooks` to:

1. Not recognize the count mode (no `select count(*) from` transformation)
2. Include `count = true` in the SQL WHERE clause via `criteriaToString`, which is invalid SQL

### Fix

1. **Criteria builder** (`src/helpers/build-quickbooks-search-criteria.ts`):

   - Now adds `{count: true}` at index 0 of the criteria array instead of `{field: 'count', value: true}`
   - Placing at index 0 works around a splice bug in `node-quickbooks` (line 2517: `criteria.splice(i, i + 1)` removes `i + 1` elements instead of 1)

2. **New helper functions**:

   - `isCountQuery(criteria)`: Checks if a criteria array/object has count mode enabled
   - `extractQueryResult(queryResponse, entityKey, isCount)`: Extracts entity array or `totalCount` from `QueryResponse`

3. **All search handlers** updated to:
   - Detect count mode using `isCountQuery`
   - Return `totalCount` as a number when in count mode
   - Return entity array otherwise

### Usage

Count mode now works consistently across all search endpoints:

```bash
mcporter call QuickBooks.search_invoices count:true --output json
# Returns: {"count": 42}

mcporter call QuickBooks.search_items count:true --output json
# Returns: {"count": 15}

mcporter call QuickBooks.search_customers count:true --output json
# Returns: {"count": 100}
```
